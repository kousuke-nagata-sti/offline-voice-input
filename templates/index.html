<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>音声入力</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Segoe UI', sans-serif;
    background: #1a1a2e;
    color: #e0e0e0;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .container {
    width: 520px;
    max-width: 95vw;
    padding: 32px;
    background: #16213e;
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  }
  h1 {
    text-align: center;
    font-size: 1.3rem;
    margin-bottom: 24px;
    color: #a0c4ff;
  }

  /* Model Status */
  .model-status {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 12px;
    border-radius: 8px;
    background: #0f3460;
    margin-bottom: 16px;
    font-size: 0.95rem;
  }
  .status-dot {
    width: 12px; height: 12px;
    border-radius: 50%;
    background: #555;
    transition: background 0.3s;
  }
  .status-dot.unloaded { background: #666; }
  .status-dot.loading { background: #f0a500; animation: pulse 1s infinite; }
  .status-dot.loaded { background: #4ecca3; }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }

  .idle-info {
    text-align: center;
    font-size: 0.8rem;
    color: #888;
    margin-bottom: 16px;
    min-height: 1.2em;
  }

  /* Buttons */
  .model-buttons {
    display: flex;
    gap: 8px;
    margin-bottom: 24px;
  }
  .model-buttons button {
    flex: 1;
    padding: 10px;
    border: none;
    border-radius: 8px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: background 0.2s, opacity 0.2s;
  }
  .model-buttons button:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }
  #btnLoad {
    background: #4ecca3;
    color: #1a1a2e;
  }
  #btnLoad:hover:not(:disabled) { background: #3dbb91; }
  #btnUnload {
    background: transparent;
    border: 1px solid #666;
    color: #888;
    font-size: 0.75rem;
    padding: 6px 10px;
    flex: 0 0 auto;
  }
  #btnUnload:hover:not(:disabled) { border-color: #e74c3c; color: #e74c3c; }

  /* Mic Button */
  .mic-area {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 24px;
  }
  #btnMic {
    width: 80px; height: 80px;
    border-radius: 50%;
    border: 3px solid #4ecca3;
    background: transparent;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }
  #btnMic:disabled {
    border-color: #444;
    opacity: 0.4;
    cursor: not-allowed;
  }
  #btnMic.recording {
    border-color: #e74c3c;
    background: rgba(231, 76, 60, 0.15);
    animation: mic-pulse 1.5s infinite;
  }
  @keyframes mic-pulse {
    0%,100% { box-shadow: 0 0 0 0 rgba(231,76,60,0.4); }
    50% { box-shadow: 0 0 0 12px rgba(231,76,60,0); }
  }
  #btnMic svg { width: 36px; height: 36px; fill: #4ecca3; }
  #btnMic.recording svg { fill: #e74c3c; }
  #btnMic:disabled svg { fill: #555; }
  .mic-label {
    margin-top: 12px;
    font-size: 1.2rem;
    font-weight: bold;
    color: #4ecca3;
    min-height: 1.4em;
    letter-spacing: 0.05em;
  }
  .mic-label.sub { font-size: 0.85rem; font-weight: normal; color: #999; }
  #btnStop {
    display: none;
    margin-top: 12px;
    padding: 10px 32px;
    border: none;
    border-radius: 8px;
    background: #e74c3c;
    color: #fff;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    letter-spacing: 0.05em;
    transition: background 0.2s;
  }
  #btnStop:hover { background: #c0392b; }
  #btnStop.show { display: block; }

  /* Result */
  .result-area {
    background: #0f3460;
    border-radius: 8px;
    padding: 16px;
    min-height: 60px;
    position: relative;
  }
  .result-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 6px;
  }
  .result-header .label {
    font-size: 0.75rem;
    color: #666;
  }
  .result-actions {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  #btnCopy {
    background: transparent;
    border: 1px solid #4ecca3;
    color: #4ecca3;
    font-size: 0.7rem;
    padding: 3px 10px;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.2s, opacity 0.2s;
  }
  #btnCopy:hover { background: rgba(78, 204, 163, 0.15); }
  #resultText {
    font-size: 1rem;
    line-height: 1.6;
    word-break: break-all;
    color: #e0e0e0;
    min-height: 6em;
    max-height: 50vh;
    overflow-y: auto;
    outline: none;
    border-radius: 4px;
    padding: 8px;
    transition: background 0.2s;
  }
  #resultText:focus { background: rgba(255,255,255,0.05); }
  #resultText.placeholder { color: #555; }
  .copied-toast {
    font-size: 0.7rem;
    color: #4ecca3;
    opacity: 0;
    transition: opacity 0.3s;
    white-space: nowrap;
  }
  .copied-toast.show { opacity: 1; }

  /* Help modal */
  .help-btn {
    display: block;
    margin: 16px auto 0;
    background: transparent;
    border: 1px solid #666;
    color: #888;
    font-size: 0.8rem;
    padding: 6px 16px;
    border-radius: 6px;
    cursor: pointer;
    transition: border-color 0.2s, color 0.2s;
  }
  .help-btn:hover { border-color: #a0c4ff; color: #a0c4ff; }
  .help-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6);
    justify-content: center;
    align-items: center;
    z-index: 100;
  }
  .help-overlay.show { display: flex; }
  .help-modal {
    background: #16213e;
    border-radius: 12px;
    padding: 24px;
    max-width: 380px;
    width: 90%;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  }
  .help-modal h2 {
    font-size: 1.1rem;
    color: #a0c4ff;
    margin-bottom: 16px;
  }
  .help-modal ol {
    padding-left: 20px;
    font-size: 0.85rem;
    line-height: 1.8;
    color: #ccc;
  }
  .help-modal .note {
    margin-top: 14px;
    font-size: 0.78rem;
    color: #f0a500;
    line-height: 1.5;
  }
  .help-close {
    display: block;
    margin: 18px auto 0;
    background: #4ecca3;
    color: #1a1a2e;
    border: none;
    padding: 8px 24px;
    border-radius: 6px;
    font-size: 0.85rem;
    cursor: pointer;
  }
  .help-close:hover { background: #3dbb91; }
</style>
</head>
<body>
<div class="container">
  <h1>音声入力</h1>

  <div class="model-status">
    <span class="status-dot unloaded" id="statusDot"></span>
    <span id="statusText">未ロード</span>
  </div>
  <div class="idle-info" id="idleInfo"></div>

  <div class="model-buttons">
    <button id="btnLoad">モデルを読み込む</button>
    <button id="btnUnload" disabled>アンロード</button>
  </div>

  <div class="mic-area">
    <button id="btnMic" disabled>
      <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
    </button>
    <div class="mic-label sub" id="micLabel">まずモデルを読み込んでください</div>
    <button id="btnStop">完了</button>
  </div>

  <div class="result-area">
    <div class="result-header">
      <div class="label">結果</div>
      <div class="result-actions">
        <div class="copied-toast" id="copiedToast">コピーしました</div>
        <button id="btnCopy">コピー</button>
      </div>
    </div>
    <div id="resultText" class="placeholder" contenteditable="true" spellcheck="false">--</div>
  </div>

  <button class="help-btn" id="btnHelp">使い方</button>
</div>

<div class="help-overlay" id="helpOverlay">
  <div class="help-modal">
    <h2>使い方</h2>
    <ol>
      <li>「モデルを読み込む」ボタンを押す（初回は少し時間がかかります）</li>
      <li>マイクボタンを押して録音開始</li>
      <li>話し終わったらもう一度マイクボタンを押す</li>
      <li>文字起こし結果が表示され、自動でクリップボードにコピーされます</li>
      <li>結果テキストはクリックして直接編集できます</li>
      <li>「コピー」ボタンで編集後のテキストもコピーできます</li>
    </ol>
    <div class="note">モデル読み込み中はメモリを消費します。5分間操作がないと自動でアンロードされます。</div>
    <button class="help-close" id="btnHelpClose">閉じる</button>
  </div>
</div>

<script>
const ws = new WebSocket(`ws://${location.host}/ws`);
const statusDot = document.getElementById('statusDot');
const statusText = document.getElementById('statusText');
const idleInfo = document.getElementById('idleInfo');
const btnLoad = document.getElementById('btnLoad');
const btnUnload = document.getElementById('btnUnload');
const btnMic = document.getElementById('btnMic');
const micLabel = document.getElementById('micLabel');
const resultText = document.getElementById('resultText');
const copiedToast = document.getElementById('copiedToast');
const btnCopy = document.getElementById('btnCopy');
const btnStop = document.getElementById('btnStop');
const btnHelp = document.getElementById('btnHelp');
const helpOverlay = document.getElementById('helpOverlay');
const btnHelpClose = document.getElementById('btnHelpClose');

let modelState = 'unloaded';
let recording = false;
let mediaRecorder = null;
let audioChunks = [];
let recStartTime = 0;
let recTimer = null;
let idleDeadline = 0;
let idleTimer = null;

// --- WebSocket ---
ws.onopen = () => console.log('WS connected');
ws.onclose = () => {
  statusText.textContent = '切断されました';
  statusDot.className = 'status-dot unloaded';
};
ws.onmessage = (e) => {
  const msg = JSON.parse(e.data);
  if (msg.type === 'status') {
    updateModelState(msg.model_state, msg.idle_remaining);
  } else if (msg.type === 'transcribing') {
    micLabel.textContent = '文字起こし中...';
    micLabel.classList.add('sub');
  } else if (msg.type === 'result') {
    resultText.textContent = msg.text || '(空)';
    resultText.classList.toggle('placeholder', !msg.text);
    micLabel.textContent = '録音する';
    micLabel.classList.remove('sub');
    if (msg.text) {
      navigator.clipboard.writeText(msg.text).then(() => showCopiedToast());
    }
  } else if (msg.type === 'error') {
    micLabel.textContent = msg.message;
    micLabel.classList.add('sub');
    setTimeout(() => { if (modelState === 'loaded') { micLabel.textContent = '録音する'; micLabel.classList.remove('sub'); } }, 3000);
  }
};

function updateModelState(state, idleRemaining) {
  modelState = state;
  statusDot.className = 'status-dot ' + state;
  const labels = { unloaded: '未ロード', loading: '読み込み中...', loaded: 'ロード済み' };
  statusText.textContent = labels[state] || state;
  btnLoad.disabled = state !== 'unloaded';
  btnUnload.disabled = state !== 'loaded';
  btnMic.disabled = state !== 'loaded';

  if (state === 'loaded') {
    micLabel.textContent = '録音する';
    micLabel.classList.remove('sub');
    if (idleRemaining != null) {
      idleDeadline = Date.now() + idleRemaining * 1000;
      startIdleCountdown();
    }
  } else {
    micLabel.textContent = state === 'loading' ? 'モデル読み込み中...' : 'まずモデルを読み込んでください';
    micLabel.classList.add('sub');
    stopIdleCountdown();
    idleInfo.textContent = '';
  }
}

function startIdleCountdown() {
  stopIdleCountdown();
  idleTimer = setInterval(() => {
    const rem = Math.max(0, Math.floor((idleDeadline - Date.now()) / 1000));
    const m = Math.floor(rem / 60);
    const s = rem % 60;
    idleInfo.textContent = `メモリ使用中 / ${m}:${String(s).padStart(2, '0')} 後に自動アンロード`;
    if (rem <= 0) stopIdleCountdown();
  }, 1000);
}
function stopIdleCountdown() {
  if (idleTimer) { clearInterval(idleTimer); idleTimer = null; }
}

// --- Copy button ---
function showCopiedToast() {
  copiedToast.classList.add('show');
  setTimeout(() => copiedToast.classList.remove('show'), 1500);
}
btnCopy.onclick = () => {
  const text = resultText.textContent;
  if (text && text !== '--' && text !== '(空)') {
    navigator.clipboard.writeText(text).then(() => showCopiedToast());
  }
};

// --- Model buttons ---
btnLoad.onclick = () => ws.send(JSON.stringify({ type: 'load_model' }));
btnUnload.onclick = () => {
  if (confirm('モデルをアンロードしますか？')) {
    ws.send(JSON.stringify({ type: 'unload_model' }));
  }
};

// --- Mic recording ---
function stopRecording() {
  recording = false;
  btnMic.classList.remove('recording');
  btnStop.classList.remove('show');
  clearInterval(recTimer);
  mediaRecorder.stop();
}

btnMic.onclick = async () => {
  if (!recording) {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      audioChunks = [];
      mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
      mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) audioChunks.push(e.data); };
      mediaRecorder.onstop = () => {
        stream.getTracks().forEach(t => t.stop());
        const blob = new Blob(audioChunks, { type: 'audio/webm' });
        const reader = new FileReader();
        reader.onloadend = () => {
          const base64 = reader.result.split(',')[1];
          ws.send(JSON.stringify({ type: 'audio', data: base64 }));
          micLabel.textContent = '送信中...';
          micLabel.classList.add('sub');
        };
        reader.readAsDataURL(blob);
      };
      mediaRecorder.start();
      recording = true;
      btnMic.classList.add('recording');
      btnStop.classList.add('show');
      recStartTime = Date.now();
      recTimer = setInterval(() => {
        const sec = ((Date.now() - recStartTime) / 1000).toFixed(1);
        micLabel.textContent = `録音中... ${sec}秒`;
        micLabel.classList.add('sub');
      }, 100);
    } catch (err) {
      micLabel.textContent = 'マイクへのアクセスが拒否されました';
    }
  } else {
    stopRecording();
  }
};

btnStop.onclick = () => { if (recording) stopRecording(); };

// --- Help modal ---
btnHelp.onclick = () => helpOverlay.classList.add('show');
btnHelpClose.onclick = () => helpOverlay.classList.remove('show');
helpOverlay.onclick = (e) => { if (e.target === helpOverlay) helpOverlay.classList.remove('show'); };
</script>
</body>
</html>
